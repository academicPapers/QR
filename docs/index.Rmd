---
title: "Regressão Quantílica"
subtitle: "Com dados imobiliários"
author: "Luiz Fernando Palin Droubi"
institute: "droubi.tech"
date: "2019/10/04 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: [default, cobreap.css]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
    seal: false
---
class: title-slide

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.align = "center", out.width = "80%", fig.path = "images/",
                      eval = TRUE)
library(knitr)
library(kableExtra)
library(ggplot2)
library(ggthemes)
theme_set(theme_few())
library(qrnn)
library(tidyr)
library(appraiseR)
library(quantreg)
```

.pull-left[
]

.pull-right[
<br><br><br><br>
### ANÁLISE DE MODELOS DE REGRESSÃO QUANTÍLICA OBTIDOS A PARTIR DE DADOS IMOBILIÁRIOS

#### Autores:

* Carlos Augusto Zilli
* Murilo Damian Ribeiro
* Luiz Fernando Palin Droubi
* Norberto Hochheim
]


---
class: primary, center, middle

# Motivação

---
class: center, middle
background-image: url("https://statisticaloddsandends.files.wordpress.com/2019/01/growth-chart.jpg")
background-size: contain

---
class: primary
# Estimativas amostrais

```{r}
data.frame(Estimativa = c("Média", "Mediana", "Quantil"),
           `Expressão` = c("\\(\\min_{\\mu \\in \\mathfrak{R}} \\sum (y_i - \\mu)^2\\)",
                           "\\(\\min_{\\xi \\in \\mathfrak{R}} \\sum|y_i - \\xi|\\)",
                           "\\(\\min_{\\xi \\in \\mathfrak{R}} \\sum \\rho_\\tau (y_i - \\xi)\\)")
           ) %>%
  knitr::kable(format = "html", escape = FALSE)
```

---
class: primary

## Função de perda ou de custo

.center2[
![](https://i.stack.imgur.com/DmKq7.png)
]

---
class: primary

## Funções para quantis variados

```{r quantis, fig.height=3.5, dev='svg'}
x <- seq(-2, 2, length=200)
`.1` <- tilted.abs(x, tau=0.1)
`.25` <- tilted.abs(x, tau=0.25)
`.5` <- tilted.abs(x, tau=0.5)
`.75` <- tilted.abs(x, tau=0.75)
`.9` <- tilted.abs(x, tau=0.9)
dados <- as.data.frame(cbind(x, `.1`, `.25`, `.5`, `.75`, `.9`))
dados <- gather(dados, "tau", y, -x)
ggplot(dados, aes(x = x, y = y, colour = tau)) + 
  geom_line() +
  ylab(bquote(rho[tau] ~ (epsilon))) +
  xlab(bquote(epsilon)) +
  guides(colour=guide_legend(title=bquote(tau)))
```

---
class: primary

## Vantagens e desvantagens

* Possibilitam explorar melhor a distribuição de probabilidade
* Não diferenciáveis em $\epsilon = 0$
* Taxa de convergência constante

---
class: primary

## Problemas de convergência 

.center2[
![](https://miro.medium.com/max/1050/1*JTC4ReFwSeAt3kvTLq1YoA.png)
]

---
class: primary

## Outras funções de perda 

.center2[
![](https://miro.medium.com/max/720/1*BploIBOUrhbgdoB1BK_sOg.png)
]



---
class: primary

## Regressão Linear vs. Quantílica

$$\min_{\mu \in \mathfrak{R}^p} \sum  (y_i - \mu(x_i, \beta))^2 $$

$$\min_{\xi \in \mathfrak{R}^p } \sum \rho_\tau (y_i - \xi(x_i, \beta))$$

---
class: primary

## Heteroscedasticidade e não-normalidade

.center2[
![](https://miro.medium.com/max/856/1*h_iOn3gSUa2bk6o0foudDA.png)
]


---
class: primary

## RQ -- duas dimensões

```{r qr1, fig.height=3.5, dev='svg'}
dados <- centro_2015@data
dados$padrao <- as.numeric(dados$padrao)
qs <- 1:9/10
qr <- rq(valor ~ area_total, data = dados, tau = qs)
ggplot(dados, aes(area_total, valor)) + 
  geom_point() + 
  geom_quantile(quantiles = qs) + 
  geom_smooth(method="lm", se = FALSE, level = .80, color = "red")
```

---
class: primary

## RQ -- transformações

```{r qr2, fig.height=3.5, dev='svg'}
qs <- 1:9/10
qr2 <- rq(log(valor) ~ log(area_total), data = dados, tau = qs)
ggplot(dados, aes(log(area_total), log(valor))) + 
  geom_point() + 
  geom_quantile(quantiles = qs) + 
  geom_smooth(method="lm", se = FALSE, color = "red")
```

---
class: primary

## Análise dos coeficientes da RQ

```{r coef1, fig.height=3.5, dev='svg'}
plot(summary(qr), parm="area_total")
```

---
class: primary, center, middle

## RQ em $p$ dimensões

---
class: center, middle

```{r}
fit <- lm(log(valor) ~ area_total + quartos + suites + garagens + 
            log(dist_b_mar) + rec(padrao), data = dados,
          subset = -c(31, 39))
fit_1 <- rq(log(valor) ~ area_total + quartos + suites + garagens + 
            log(dist_b_mar) + rec(padrao), data = dados)
fit_2 <- rq(log(valor) ~ area_total + quartos + suites + garagens +
            log(dist_b_mar) + rec(padrao), data = dados, tau = .1)
fit_3 <- rq(log(valor) ~ area_total + quartos + suites + garagens +
            log(dist_b_mar) + rec(padrao), data = dados, tau = .9)
fit_qr <- rq(log(valor) ~ area_total + quartos + suites + garagens + 
            log(dist_b_mar) + rec(padrao), data = dados, tau = qs)
```

```{r coefs, out.width = "100%", fig.height=4.5, dev='svg'}
plot(summary(fit_qr))
```

---
class: primary

## Predições

```{r}
p <- predict(fit, newdata = dados[52,], interval = "confidence", level = .80)
pp <- predict(fit, newdata = dados[52,], interval = "prediction", level = .80)
p1 <- predict(fit_1, newdata = dados[52,], interval = "confidence", level = .80)
p2 <- predict(fit_2, newdata = dados[52,], interval = "confidence", level = .80)
p3 <- predict(fit_3, newdata = dados[52,], interval = "confidence", level = .80)
P <- brformat(exp(p))
PP <- brformat(exp(pp))
P1 <- brformat(exp(p1))
P2 <- brformat(exp(p2))
P3 <- brformat(exp(p3))
```

|                      | 10%           | 50% ou média  | 90%           | 
|:---------------------|--------------:|--------------:|--------------:|
| Regressão linear (IP)|`r PP[, "lwr"]`|`r PP[, "fit"]`|`r PP[, "upr"]`|
| Regressão quantílica |`r P2[, "fit"]`|`r P1[, "fit"]`|`r P3[, "fit"]`|

---
class: primary

## Comparação

.pull-left[
* Regressão Linear à média
  + Solução única
  + Maior Eficiência Estatística
  + Sensível a *outliers*
  + Sensível à heteroscedasticidade
  + Não caracteriza outros quantis
]
.pull-right[
* Regressão Quantílica
  + Solução Iterativa
  + Menor Eficiência Estatística
  + Robusta a *outliers*
  + Robusta a heteroscedasticidade
  + Caracteriza outros quantis

]