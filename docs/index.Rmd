---
title: "Regressão Quantílica"
author: 
- "Carlos Augusto Zilli"
- "Murilo Damian Ribeiro"
- "Luiz Fernando Palin Droubi"
- "Norberto Hochheim"
output:
  rmdshower::shower_presentation:
    theme: mango
    self_contained: false
    katex: true
    ratio: 16x10
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = FALSE, message=FALSE, warning = FALSE, 
                      fig.path = "images/")
swjpg <- system.file('examples', 'sw.jpg', package = 'rmdshower')
scifi <- system.file('examples', 'scifi.jpg', package = 'rmdshower')
qr1 <- "https://miro.medium.com/max/739/1*mF9Pv4NNnzZhT1ocEPOgvQ.png"
qr2 <- "https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcTEZ7QB7aWDvu8lUbPMDVbh6u8fvMirNNHSAeGIAetXEAQ0Tji0"
type <- knitr::opts_knit$get("rmarkdown.pandoc.to")
options(digits = 10)
library(appraiseR)
library(quantreg)
library(qrnn)
library(tidyr)
library(ggplot2)
library(ggthemes)
theme_set(theme_few())
library(stargazer)
```

## Regressão Quantílica

<img src="`r qr1`" class="fullpage">

# Motivação

## { .fullpage }

<img src="https://statisticaloddsandends.files.wordpress.com/2019/01/growth-chart.jpg" class="fullpage">


## Média vs. Mediana

1. Média

$$\min_{\mu \in \mathfrak{R}} \sum (y_i - \mu)^2$$
2. Mediana

$$\min_{\xi \in \mathfrak{R}} \sum|y_i - \xi|$$

$$\min_{\xi \in \mathfrak{R}} \sum \rho_\tau (y_i - \xi)$$

## Função de perda ou de custo

```{r}
x <- seq(-2, 2, length=200)
`.1` <- tilted.abs(x, tau=0.1)
`.25` <- tilted.abs(x, tau=0.25)
`.5` <- tilted.abs(x, tau=0.5)
`.75` <- tilted.abs(x, tau=0.75)
`.9` <- tilted.abs(x, tau=0.9)
dados <- as.data.frame(cbind(x, `.1`, `.25`, `.5`, `.75`, `.9`))
dados <- gather(dados, "tau", y, -x)
ggplot(dados, aes(x = x, y = y, colour = tau)) + 
  geom_line() +
  ylab(bquote(rho[tau] ~ (epsilon))) +
  xlab(bquote(epsilon)) +
  guides(colour=guide_legend(title=bquote(tau)))
```


## Regressão Linear vs. Quantílica

$$\min_{\mu \in \mathfrak{R}^p} \sum  (y_i - \mu(x_i, \beta))^2 $$

$$\min_{\xi \in \mathfrak{R}^p } \sum \rho_\tau (y_i - \xi(x_i, \beta))$$

## RQ -- duas dimensões

```{r qr1}
dados <- centro_2015@data
dados$padrao <- as.numeric(dados$padrao)
qs <- 1:9/10
qr <- rq(valor ~ area_total, data = dados, tau = qs)
ggplot(dados, aes(area_total, valor)) + 
  geom_point() + 
  geom_quantile(quantiles = qs) + 
  geom_smooth(method="lm", se = TRUE, level = .80, color = "red")
```

## RQ -- transformações

```{r qr2}
qs <- 1:9/10
qr2 <- rq(log(valor) ~ log(area_total), data = dados, tau = qs)
ggplot(dados, aes(log(area_total), log(valor))) + 
  geom_point() + 
  geom_quantile(quantiles = qs) + 
  geom_smooth(method="lm", se = FALSE, color = "red")
```

## Análise dos coeficientes da RQ

```{r coef1}
plot(summary(qr), parm="area_total")
```

# RQ em $p$ dimensões

```{r}
fit <- lm(log(valor) ~ area_total + quartos + suites + garagens + 
            log(dist_b_mar) + rec(padrao), data = dados,
          subset = -c(31, 39))
fit_1 <- rq(log(valor) ~ area_total + quartos + suites + garagens + 
            log(dist_b_mar) + rec(padrao), data = dados)
fit_2 <- rq(log(valor) ~ area_total + quartos + suites + garagens +
            log(dist_b_mar) + rec(padrao), data = dados, tau = .1)
fit_3 <- rq(log(valor) ~ area_total + quartos + suites + garagens +
            log(dist_b_mar) + rec(padrao), data = dados, tau = .9)
fit_qr <- rq(log(valor) ~ area_total + quartos + suites + garagens + 
            log(dist_b_mar) + rec(padrao), data = dados, tau = qs)
```

## { .fullpage }


<div class="fullpage width">
```{r coefs}
plot(summary(fit_qr))
```
</div>

## Comparações

```{r}
p <- predict(fit, newdata = dados[52,], interval = "confidence", level = .80)
pp <- predict(fit, newdata = dados[52,], interval = "prediction", level = .80)
p1 <- predict(fit_1, newdata = dados[52,], interval = "confidence", level = .80)
p2 <- predict(fit_2, newdata = dados[52,], interval = "confidence", level = .80)
p3 <- predict(fit_3, newdata = dados[52,], interval = "confidence", level = .80)
P <- brformat(exp(p))
PP <- brformat(exp(pp))
P1 <- brformat(exp(p1))
P2 <- brformat(exp(p2))
P3 <- brformat(exp(p3))
```

|                      | 10%           | 50% ou média  | 90%           | 
|:---------------------|--------------:|--------------:|--------------:|
| Regressão linear (IP)|`r PP[, "lwr"]`|`r PP[, "fit"]`|`r PP[, "upr"]`|
| Regressão quantílica |`r P2[, "fit"]`|`r P1[, "fit"]`|`r P3[, "fit"]`|

## Comparação

<div class="double">
<p class="double-flow">
* Regressão Linear à média
  + Maior Eficiência
  + Sensível a *outliers*
  + Sensível à heteroscedasticidade
  + Não caracteriza outros quantis
</p><p class="double-flow">
* Regressão Quantílica
  + Menor Eficiência
  + Robusta a *outliers*
  + Robusta a heteroscedasticidade
  + Caracteriza outros quantis
</p>
</div>


## More information

### About R markdown: http://rmarkdown.rstudio.com

### About shower: https://github.com/shower/shower

### Example shower presentation: http://shwr.me/
